{% extends 'base.html' %}

{% block content %}
<style>
    /* ìº˜ë¦°ë” ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
    #calendar {
        max-width: 100%;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 20px; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ */
        box-shadow: 0 4px 15px rgba(0,0,0,0.05); /* ë¶€ë“œëŸ¬ìš´ ê·¸ë¦¼ì */
    }
    
    /* ì¼ì • ë§‰ëŒ€ ìŠ¤íƒ€ì¼ */
    .fc-event {
        cursor: pointer;
        border: none;
        border-radius: 4px;
        padding: 2px 4px;
        font-size: 0.9rem;
        transition: transform 0.1s;
    }
    .fc-event:hover {
        transform: scale(1.02); /* ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ì‚´ì§ ì»¤ì§ */
    }
    .fc-day-grid-event .fc-content {
        white-space: normal;
        font-weight: 500;
    }

    /* ìº˜ë¦°ë” ìƒë‹¨ íˆ´ë°” ìŠ¤íƒ€ì¼ */
    .fc-toolbar-title {
        font-size: 1.5rem !important;
        font-weight: 800;
        color: #333;
    }
    .fc-button-primary {
        background-color: #03cf5d !important; /* ë„¤ì´ë²„ ê·¸ë¦° */
        border-color: #03cf5d !important;
        font-weight: bold;
    }
    .fc-button-primary:hover {
        background-color: #02b350 !important;
        border-color: #02b350 !important;
    }

    /* ëª¨ë‹¬(íŒì—…) ìŠ¤íƒ€ì¼ */
    .modal-content {
        border-radius: 20px;
        overflow: hidden;
        border: none;
    }
    .modal-header {
        background: #f8f9fa;
        border-bottom: 1px solid #eee;
    }
</style>

<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold m-0" style="color: #1e1e1e;">ğŸ“… ìŠ¤ì¼€ì¤„ëŸ¬</h4>
    <button class="btn btn-success rounded-pill px-4 fw-bold shadow-sm" style="background-color: #03cf5d; border: none;" onclick="openModal('')">
        + ì¼ì • ì‹ ì²­
    </button>
</div>

<div id='calendar'></div>

<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg">
            <div class="modal-header px-4 pt-4 pb-2 border-0">
                <h5 class="modal-title fw-bold">ì¼ì • ê´€ë¦¬</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <iframe id="applyFrame" src="" width="100%" height="500px" style="border:none;"></iframe>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var eventModal = new bootstrap.Modal(document.getElementById('eventModal'));

        // ìº˜ë¦°ë” ì„¤ì • ì‹œì‘
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth', // ì›”ê°„ ë‹¬ë ¥ ê¸°ë³¸
            locale: 'ko', // í•œêµ­ì–´ ì„¤ì •
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,listMonth'
            },
            
            // [í•µì‹¬] ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ë° ë‚ ì§œ ë³´ì • ë¡œì§
            events: function(info, successCallback, failureCallback) {
                // start, end íŒŒë¼ë¯¸í„°ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ë¶™ì—¬ì„œ ìš”ì²­ (ë°°ë‹¬ ì‚¬ê³  ë°©ì§€)
                fetch("{% url 'calendarapp:event_list' %}?start=" + info.startStr + "&end=" + info.endStr)
                    .then(response => response.json())
                    .then(data => {
                        // ê°€ì ¸ì˜¨ ë°ì´í„°ë¥¼ í•˜ë‚˜ì”© ê²€ì‚¬í•´ì„œ ë‚ ì§œë¥¼ ê³ ì¹©ë‹ˆë‹¤.
                        var fixedEvents = data.map(function(event) {
                            
                            // 1. ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì´ ê°™ìœ¼ë©´ (ì˜ˆ: ë°˜ì°¨, 1ì¼ ì—°ì°¨)
                            // -> ì¢…ë£Œì¼ì„ nullë¡œ ë§Œë“¤ì–´ì„œ 'í•˜ë£¨ ì¢…ì¼ ì¼ì •'ìœ¼ë¡œ ì¸ì‹ì‹œí‚´
                            if (event.start === event.end) {
                                event.end = null; 
                            } 
                            // 2. ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì´ ë‹¤ë¥´ë©´ (ì˜ˆ: íœ´ê°€ 12ì¼~13ì¼)
                            // -> ì¢…ë£Œì¼ì— +1ì¼ì„ ë”í•´ì¤˜ì•¼ ë‹¬ë ¥ì— ë§ˆì§€ë§‰ ë‚ ì§œê¹Œì§€ ê½‰ ì±„ì›Œì ¸ ë³´ì„
                            else if (event.end) {
                                var endDate = new Date(event.end);
                                endDate.setDate(endDate.getDate() + 1); // í•˜ë£¨ ë”í•˜ê¸°
                                event.end = endDate.toISOString().split('T')[0]; // YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                            }
                            return event;
                        });
                        successCallback(fixedEvents);
                    })
                    .catch(error => {
                        console.error('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
                        failureCallback(error);
                    });
            },

            // ë‚ ì§œ í´ë¦­ ì‹œ (ìƒˆ ì¼ì • ì‹ ì²­)
            dateClick: function(info) {
                openModal(info.dateStr); // í´ë¦­í•œ ë‚ ì§œë¥¼ ë„˜ê²¨ì¤Œ
            },

            // ì¼ì • í´ë¦­ ì‹œ (ìˆ˜ì •/ì‚­ì œ)
            eventClick: function(info) {
                // iframeì— ìˆ˜ì • í˜ì´ì§€ ë„ìš°ê¸° (edit íŒŒë¼ë¯¸í„° ì „ë‹¬)
                var editUrl = "{% url 'calendarapp:apply' %}?edit=" + info.event.id;
                document.getElementById('applyFrame').src = editUrl;
                eventModal.show();
            }
        });

        // ìº˜ë¦°ë” í™”ë©´ì— ê·¸ë¦¬ê¸°
        calendar.render();

        // íŒì—…ì°½ ì—´ê¸° í•¨ìˆ˜ (ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡)
        window.openModal = function(dateStr) {
            var url = "{% url 'calendarapp:apply' %}";
            if(dateStr) url += "?date=" + dateStr; // ë‚ ì§œê°€ ìˆìœ¼ë©´ URLì— ë¶™ì—¬ì„œ ì „ë‹¬
            document.getElementById('applyFrame').src = url;
            eventModal.show();
        }

        // ì•„ì´í”„ë ˆì„(íŒì—…)ì—ì„œ "ì €ì¥ ì™„ë£Œ" ì‹ í˜¸ë¥¼ ë°›ìœ¼ë©´ ì‹¤í–‰ë˜ëŠ” ì½”ë“œ
        window.addEventListener('message', function(event) {
            if (event.data === 'submitted') {
                eventModal.hide(); // íŒì—… ë‹«ê¸°
                calendar.refetchEvents(); // ìº˜ë¦°ë” ë°ì´í„° ìƒˆë¡œê³ ì¹¨ (ê¹œë¹¡ì„ ì—†ì´ ë°ì´í„°ë§Œ ê°±ì‹ )
            }
        });
    });
</script>
{% endblock %}