{% extends 'base.html' %}

{% block content %}
<style>
    /* ìº˜ë¦°ë” ìŠ¤íƒ€ì¼ ì»¤ìŠ¤í…€ */
    #calendar {
        max-width: 100%;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    .fc-event {
        cursor: pointer;
        border: none;
        border-radius: 4px;
        padding: 2px 4px;
        font-size: 0.9em;
    }
    .fc-day-grid-event .fc-content {
        white-space: normal;
    }
    .fc-toolbar-title {
        font-size: 1.5em !important;
        font-weight: bold;
        color: #333;
    }
    .fc-button-primary {
        background-color: #03cf5d !important;
        border-color: #03cf5d !important;
        font-weight: bold;
    }
    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .modal-content {
        border-radius: 20px;
        overflow: hidden;
        border: none;
    }
    .modal-header {
        background: #f8f9fa;
        border-bottom: 1px solid #eee;
    }
</style>

<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold m-0">ğŸ“… ìŠ¤ì¼€ì¤„ëŸ¬</h4>
    <button class="btn btn-success rounded-pill px-4 fw-bold" onclick="openModal('')">
        + ì¼ì • ì‹ ì²­
    </button>
</div>

<div id='calendar'></div>

<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">ì¼ì • ê´€ë¦¬</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <iframe id="applyFrame" src="" width="100%" height="450px" style="border:none;"></iframe>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var eventModal = new bootstrap.Modal(document.getElementById('eventModal'));

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'ko', // í•œêµ­ì–´ ì„¤ì •
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,listMonth'
            },
            
            // [í•µì‹¬ 1] ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ë° ë‚ ì§œ ë²„ê·¸ ìˆ˜ì •
            events: function(info, successCallback, failureCallback) {
                fetch("{% url 'calendarapp:event_list' %}")
                    .then(response => response.json())
                    .then(data => {
                        // ë°ì´í„°ë¥¼ í•˜ë‚˜ì”© êº¼ë‚´ì„œ ê³ ì¹©ë‹ˆë‹¤.
                        var fixedEvents = data.map(function(event) {
                            // ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì´ ê°™ìœ¼ë©´ ì¢…ë£Œì¼ì„ ì—†ì• ë²„ë¦¼ (ê·¸ëŸ¬ë©´ í•˜ë£¨ ì¢…ì¼ë¡œ ì¸ì‹ë¨)
                            if (event.start === event.end) {
                                event.end = null; 
                            }
                            return event;
                        });
                        successCallback(fixedEvents);
                    })
                    .catch(error => {
                        console.error('ì—ëŸ¬ ë°œìƒ:', error);
                        failureCallback(error);
                    });
            },

            // ë‚ ì§œ í´ë¦­ ì‹œ (ìƒˆ ì¼ì • ì‹ ì²­)
            dateClick: function(info) {
                openModal(info.dateStr);
            },

            // ì¼ì • í´ë¦­ ì‹œ (ìˆ˜ì •/ì‚­ì œ)
            eventClick: function(info) {
                // iframeì— ìˆ˜ì • í˜ì´ì§€ ë„ìš°ê¸° (edit íŒŒë¼ë¯¸í„° ì „ë‹¬)
                var editUrl = "{% url 'calendarapp:apply' %}?edit=" + info.event.id;
                document.getElementById('applyFrame').src = editUrl;
                eventModal.show();
            }
        });

        calendar.render();

        // [í•µì‹¬ 2] íŒì—…ì°½ ì—´ê¸° í•¨ìˆ˜
        window.openModal = function(dateStr) {
            var url = "{% url 'calendarapp:apply' %}";
            if(dateStr) url += "?date=" + dateStr;
            document.getElementById('applyFrame').src = url;
            eventModal.show();
        }

        // [í•µì‹¬ 3] ì•„ì´í”„ë ˆì„(íŒì—…)ì—ì„œ "ì €ì¥ ì™„ë£Œ" ì‹ í˜¸ë¥¼ ë³´ë‚´ë©´ ë‹«ê³  ìƒˆë¡œê³ ì¹¨
        window.addEventListener('message', function(event) {
            if (event.data === 'submitted') {
                eventModal.hide();
                calendar.refetchEvents(); // ìº˜ë¦°ë” ë°ì´í„°ë§Œ ìƒˆë¡œê³ ì¹¨ (ê¹œë¹¡ì„ ì—†ìŒ)
            }
        });
    });
</script>
{% endblock %}