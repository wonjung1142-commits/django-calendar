{% extends 'base.html' %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8 mx-auto">
        <form method="get" class="d-flex gap-2 mb-3">
            <input type="text" name="q" class="form-control form-control-lg rounded-pill px-4" 
                   placeholder="ì•½í’ˆëª… ë˜ëŠ” ì½”ë“œ ê²€ìƒ‰..." value="{{ q }}">
            <button type="submit" class="btn btn-primary rounded-pill px-4 fw-bold">ê²€ìƒ‰</button>
        </form>

        <div class="d-flex gap-2 overflow-auto pb-2" style="white-space: nowrap;">
            <a href="?q={{ q }}" 
               class="btn rounded-pill px-3 fw-bold {% if not selected_cabinet %}btn-dark{% else %}btn-outline-secondary{% endif %}">
               ì „ì²´
            </a>

            {% for rack in racks %}
            <a href="?q={{ q }}&cabinet={{ rack }}" 
               class="btn rounded-pill px-3 fw-bold {% if selected_cabinet == rack %}btn-success{% else %}btn-outline-success{% endif %}">
               {{ rack }}ë²ˆ ì•½ì¥
            </a>
            {% endfor %}
        </div>
    </div>
</div>

{% if is_search %}
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
        {% for medicine in medicines_list %}
        <div class="col">
            <div class="card h-100 shadow-sm border-0 rounded-4" onclick="editMedicine('{{ medicine.id }}')" style="cursor: pointer; transition: transform 0.2s;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="card-title fw-bold mb-0 text-dark">{{ medicine.name }}</h5>
                        <span class="badge bg-primary rounded-pill">{{ medicine.location.pos_number }}</span>
                    </div>
                    <p class="card-text text-muted small mb-1">{{ medicine.specification|default:"ê·œê²© ì—†ìŒ" }}</p>
                    <p class="card-text text-secondary small">ì½”ë“œ: {{ medicine.code|default:"-" }}</p>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12 text-center py-5">
            <p class="text-muted">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
        {% endfor %}
    </div>
{% else %}
    <div class="text-center py-5 text-muted">
        <h3>ğŸ” ì•½í’ˆì„ ê²€ìƒ‰í•˜ê±°ë‚˜ ì•½ì¥ì„ ì„ íƒí•˜ì„¸ìš”</h3>
    </div>
{% endif %}

<div class="modal fade" id="medModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0 shadow">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="modalTitle">ì•½í’ˆ ì •ë³´</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="medForm">
                    <input type="hidden" name="med_id" id="med_id">
                    <div class="mb-3">
                        <label class="form-label text-secondary small">ì•½í’ˆëª…</label>
                        <input type="text" class="form-control" name="name" id="med_name" required>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col">
                            <label class="form-label text-secondary small">ìœ„ì¹˜ (ì˜ˆ: 1-1)</label>
                            <input type="text" class="form-control" name="location" id="med_location">
                        </div>
                        <div class="col">
                            <label class="form-label text-secondary small">ê·œê²©</label>
                            <input type="text" class="form-control" name="spec" id="med_spec">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-secondary small">ë³´í—˜ì½”ë“œ</label>
                        <input type="text" class="form-control" name="code" id="med_code">
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-primary rounded-pill w-100 fw-bold" onclick="saveMedicine()">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>
</div>

<script>
    // [ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ ê¸°ëŠ¥ ìœ ì§€]
    var medModal = new bootstrap.Modal(document.getElementById('medModal'));

    function editMedicine(id) {
        // (ê°„ë‹¨í•˜ê²Œ êµ¬í˜„: ì‹¤ì œë¡œëŠ” ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê±°ë‚˜, HTML data ì†ì„±ì„ í™œìš©í•  ìˆ˜ ìˆìŒ)
        // ì—¬ê¸°ì„œëŠ” ìƒˆë¡œ ì¶”ê°€í•˜ëŠ” ê¸°ëŠ¥ ìœ„ì£¼ë¡œ ë‘¡ë‹ˆë‹¤. ìƒì„¸ ìˆ˜ì •ì€ ì¶”í›„ ê³ ë„í™” ê°€ëŠ¥
        document.getElementById('modalTitle').innerText = 'ì•½í’ˆ ìˆ˜ì •';
        document.getElementById('med_id').value = id;
        medModal.show();
    }

    function openAddModal() {
        document.getElementById('modalTitle').innerText = 'ì•½í’ˆ ì¶”ê°€';
        document.getElementById('medForm').reset();
        document.getElementById('med_id').value = '';
        medModal.show();
    }

    function saveMedicine() {
        var formData = new FormData(document.getElementById('medForm'));
        fetch("{% url 'inventory:medicine_save' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        }).then(res => res.json())
        .then(data => {
            if(data.status === 'success') {
                location.reload();
            } else {
                alert('ì €ì¥ ì‹¤íŒ¨');
            }
        });
    }
</script>
{% endblock %}