{% extends 'base.html' %}

{% block content %}
<style>
    /* ìº˜ë¦°ë” ë””ìì¸ */
    #calendar {
        max-width: 100%; margin: 0 auto; background: white; padding: 20px;
        border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    .fc-event { cursor: pointer; border: none; border-radius: 4px; padding: 2px 4px; font-size: 0.9rem; }
    .fc-event:hover { transform: scale(1.02); }
    .fc-toolbar-title { font-size: 1.5rem !important; font-weight: 800; color: #333; }
    .fc-button-primary { background-color: #03cf5d !important; border-color: #03cf5d !important; font-weight: bold; }
    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .modal-content { border-radius: 20px; border: none; }
    .modal-header { background: #f8f9fa; border-bottom: 1px solid #eee; }
</style>

<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold m-0" style="color: #1e1e1e;">ğŸ“… ìŠ¤ì¼€ì¤„ëŸ¬</h4>
    <button class="btn btn-success rounded-pill px-4 fw-bold shadow-sm" style="background-color: #03cf5d; border: none;" onclick="openModal('')">
        + ì¼ì • ì‹ ì²­
    </button>
</div>

<div id='calendar'></div>

<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg">
            <div class="modal-header px-4 pt-4 pb-2 border-0">
                <h5 class="modal-title fw-bold">ì¼ì • ê´€ë¦¬</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <iframe id="applyFrame" src="" width="100%" height="500px" style="border:none;"></iframe>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var eventModal = new bootstrap.Modal(document.getElementById('eventModal'));

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'ko',
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,listMonth' },
            
            // [ì—¬ê¸°ê°€ í•µì‹¬!] ì„œë²„ëŠ” ê·¸ëŒ€ë¡œ ë‘ê³ , ë°›ì•„ì˜¨ ë°ì´í„°ë¥¼ í™”ë©´ì—ì„œ ê³ ì¹©ë‹ˆë‹¤.
            events: function(info, successCallback, failureCallback) {
                // ê¸°ì¡´ views.pyê°€ start, end íŒŒë¼ë¯¸í„°ë¥¼ ë°›ìœ¼ë¯€ë¡œ ê·¸ëŒ€ë¡œ ë§ì¶°ì„œ ìš”ì²­í•©ë‹ˆë‹¤.
                fetch("{% url 'calendarapp:event_list' %}?start=" + info.startStr + "&end=" + info.endStr)
                    .then(response => response.json())
                    .then(data => {
                        // ê°€ì ¸ì˜¨ ë°ì´í„°ë¥¼ ìë°”ìŠ¤í¬ë¦½íŠ¸ê°€ í•˜ë‚˜ì”© ìˆ˜ë¦¬í•©ë‹ˆë‹¤.
                        var fixedEvents = data.map(function(event) {
                            
                            // 1. ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì´ ê°™ìœ¼ë©´ (ì˜ˆ: ë°˜ì°¨) -> ì¢…ë£Œì¼ì„ ì§€ì›Œì„œ 'í•˜ë£¨ ì¢…ì¼'ë¡œ ë§Œë“¦
                            if (event.start === event.end) {
                                event.end = null; 
                            } 
                            // 2. ì¢…ë£Œì¼ì´ ìˆìœ¼ë©´ (ì˜ˆ: íœ´ê°€ 12~13ì¼) -> ë‹¬ë ¥ì€ ì¢…ë£Œì¼ 00ì‹œê¹Œì§€ë§Œ ë³´ì—¬ì£¼ë¯€ë¡œ +1ì¼ì„ í•´ì„œ ê½‰ ì±„ì›€
                            else if (event.end) {
                                var endDate = new Date(event.end);
                                endDate.setDate(endDate.getDate() + 1);
                                event.end = endDate.toISOString().split('T')[0];
                            }
                            return event;
                        });
                        successCallback(fixedEvents);
                    })
                    .catch(error => {
                        console.error('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
                        failureCallback(error);
                    });
            },

            // ë‚ ì§œ í´ë¦­ ì‹œ íŒì—…
            dateClick: function(info) { openModal(info.dateStr); },

            // ì¼ì • í´ë¦­ ì‹œ íŒì—…
            eventClick: function(info) {
                var editUrl = "{% url 'calendarapp:apply' %}?edit=" + info.event.id;
                document.getElementById('applyFrame').src = editUrl;
                eventModal.show();
            }
        });

        calendar.render();

        // íŒì—… ì—´ê¸° ê¸°ëŠ¥
        window.openModal = function(dateStr) {
            var url = "{% url 'calendarapp:apply' %}";
            if(dateStr) url += "?date=" + dateStr;
            document.getElementById('applyFrame').src = url;
            eventModal.show();
        }

        // íŒì—…ì—ì„œ ì €ì¥í•˜ë©´ ìƒˆë¡œê³ ì¹¨
        window.addEventListener('message', function(event) {
            if (event.data === 'submitted') {
                eventModal.hide();
                calendar.refetchEvents();
            }
        });
    });
</script>
{% endblock %}