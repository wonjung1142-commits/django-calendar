{% extends 'base.html' %}
{% block content %}
<style>
    body { background-color: #f0f2f5; }
    .cabinet-card { background: white; border-radius: 15px; padding: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .btn-cabinet { width: 42px; height: 42px; margin: 3px; display: inline-flex; align-items: center; justify-content: center; font-size: 0.85rem; border-radius: 10px; }
    .medicine-card { border-radius: 12px; border: none; transition: 0.2s; cursor: pointer; }
    .medicine-card:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
    .filter-pill { border-radius: 20px; font-size: 0.85rem; padding: 5px 15px; }
</style>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold text-primary m-0">ğŸ’Š ì•½í’ˆ ì¬ê³  ë§ˆìŠ¤í„°</h4>
        <button class="btn btn-primary rounded-pill px-4 shadow-sm" onclick="openModal()">+ ì•½í’ˆ ì‹ ê·œ ì¶”ê°€</button>
    </div>

    <div class="card border-0 shadow-sm mb-4" style="border-radius: 15px;">
        <div class="card-body">
            <form method="get" id="filterForm">
                <div class="input-group mb-3">
                    <input type="text" name="q" class="form-control border-0 bg-light" placeholder="ì•½í’ˆëª… ë˜ëŠ” ë³´í—˜ì½”ë“œë¡œ ê²€ìƒ‰í•˜ì„¸ìš”" value="{{ q }}" style="border-radius: 10px 0 0 10px;">
                    <button class="btn btn-primary px-4" type="submit" style="border-radius: 0 10px 10px 0;">ê²€ìƒ‰</button>
                </div>
                
                <div class="d-flex gap-2 flex-wrap">
                    <input type="radio" class="btn-check" name="code_filter" id="all" value="all" {% if code_filter == 'all' %}checked{% endif %} onchange="this.form.submit()">
                    <label class="btn btn-outline-secondary filter-pill" for="all">ì „ì²´</label>
                    
                    <input type="radio" class="btn-check" name="code_filter" id="yes" value="yes" {% if code_filter == 'yes' %}checked{% endif %} onchange="this.form.submit()">
                    <label class="btn btn-outline-success filter-pill" for="yes">ë³´í—˜ì½”ë“œ ìˆìŒ</label>
                    
                    <input type="radio" class="btn-check" name="code_filter" id="no" value="no" {% if code_filter == 'no' %}checked{% endif %} onchange="this.form.submit()">
                    <label class="btn btn-outline-danger filter-pill" for="no">ë³´í—˜ì½”ë“œ ì—†ìŒ</label>
                </div>
            </form>
        </div>
    </div>

    <div class="cabinet-card mb-4">
        <h6 class="fw-bold mb-3"><i class="bi bi-grid-3x3-gap"></i> ì•½ì¥ ìœ„ì¹˜ ì„ íƒ</h6>
        <div class="d-flex flex-wrap">
            <a href="?cabinet=&code_filter={{ code_filter }}" class="btn {% if not selected_cabinet %}btn-dark{% else %}btn-outline-dark{% endif %} btn-cabinet">ì „</a>
            {% for loc in locations %}
                <a href="?cabinet={{ loc.pos_number }}&code_filter={{ code_filter }}" 
                   class="btn {% if selected_cabinet == loc.pos_number %}btn-primary{% else %}btn-outline-primary{% endif %} btn-cabinet">
                    {{ loc.pos_number }}
                </a>
            {% endfor %}
        </div>
    </div>

    <div class="results">
        {% if not is_search %}
            <div class="text-center py-5">
                <img src="https://cdn-icons-png.flaticon.com/512/2312/2312440.png" width="80" style="opacity: 0.2;">
                <p class="text-muted mt-3">ì•½ì¥ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì—¬ ë¦¬ìŠ¤íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
            </div>
        {% else %}
            <p class="small text-muted mb-3">ì´ {{ medicines_list|length }}ê°œì˜ ì•½í’ˆì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            <div class="row row-cols-1 row-cols-md-2 g-3">
                {% for m in medicines_list %}
                <div class="col">
                    <div class="card medicine-card shadow-sm h-100">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div onclick="openModal('{{ m.id }}', '{{ m.name|escapejs }}', '{{ m.code|escapejs }}', '{{ m.specification|escapejs }}', '{{ m.location.pos_number|escapejs }}')">
                                <span class="badge bg-light text-primary mb-1">{{ m.location.pos_number }}</span>
                                <h6 class="fw-bold mb-1">{{ m.name }}</h6>
                                <div class="small text-secondary">{{ m.specification }} | ì½”ë“œ: {{ m.code|default:"-" }}</div>
                            </div>
                            <button class="btn btn-sm btn-light text-primary fw-bold" onclick="openModal('{{ m.id }}', '{{ m.name|escapejs }}', '{{ m.code|escapejs }}', '{{ m.specification|escapejs }}', '{{ m.location.pos_number|escapejs }}')">ìˆ˜ì •</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>
</div>

<div class="modal fade" id="medModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
            <div class="modal-header border-0 pb-0">
                <h5 class="fw-bold" id="mTitle">ì•½í’ˆ ì •ë³´</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="medForm">
                {% csrf_token %}
                <input type="hidden" name="med_id" id="m_id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">ì•½í’ˆëª…</label>
                        <input type="text" name="name" id="m_name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">ë³´í—˜ì½”ë“œ</label>
                        <input type="text" name="code" id="m_code" class="form-control">
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label small fw-bold">ê·œê²©</label>
                            <input type="text" name="spec" id="m_spec" class="form-control">
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label small fw-bold">ìœ„ì¹˜(ì•½ì¥ë²ˆí˜¸)</label>
                            <input type="text" name="location" id="m_loc" class="form-control" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">ë‹«ê¸°</button>
                    <button type="button" class="btn btn-primary rounded-pill px-4" onclick="doSave()">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let medModal;
document.addEventListener('DOMContentLoaded', function() {
    medModal = new bootstrap.Modal(document.getElementById('medModal'));
});

function openModal(id='', name='', code='', spec='', loc='') {
    document.getElementById('m_id').value = id;
    document.getElementById('m_name').value = name;
    document.getElementById('m_code').value = code;
    document.getElementById('m_spec').value = spec;
    document.getElementById('m_loc').value = loc;
    document.getElementById('mTitle').innerText = id ? "ì•½í’ˆ ì •ë³´ ìˆ˜ì •" : "ìƒˆ ì•½í’ˆ ì¶”ê°€";
    medModal.show();
}

function doSave() {
    const fData = new FormData(document.getElementById('medForm'));
    fetch("{% url 'inventory:medicine_save' %}", {
        method: "POST",
        body: fData,
        headers: { "X-CSRFToken": "{{ csrf_token }}" }
    }).then(r => r.json()).then(d => {
        if(d.status === 'success') location.reload();
        else alert("ì €ì¥ ì‹¤íŒ¨");
    });
}
</script>
{% endblock %}